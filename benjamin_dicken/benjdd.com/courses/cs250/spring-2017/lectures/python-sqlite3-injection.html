<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>cs250</title>
  <link href="https://fonts.googleapis.com/css?family=Lato:900|Work+Sans" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">

  <link rel="stylesheet" href="/lib/highlight/styles/default.css">
  <script src="/lib/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- Google fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Poppins:ital,wght@0,400;0,700;1,400;1,700&family=Questrial&family=Roboto+Flex:opsz,wdth,wght,YTDE@8..144,110,400,-230;8..144,110,700,-230&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,100;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

  <style>
  .lnp {
    font-size: 1.5em;
  }
  </style>

</head>
<body style="background-color: rgb(255, 255, 255)">
<script src="/js/theme.min.js"></script>

  <h1 id="csc-250-lecture-notes-sqlite3-injection">CSc 250: Lecture Notes: sqlite3 Injection!</h1>

<p>Today we’re going to learn how to hack :)</p>

<p><img src="/assets/memes/hacker.jpg" width="200" /></p>

<h2 id="sql-injection">SQL Injection</h2>

<p>SQL Injection is a hacking technique that can be used (by hackers) to run SQL command maliciously.
SQL Injection can be used when there is an application that executes one (or more) SQL commands, and uses user input to construct the query.
If the programmer is not careful, a user with ill intent could insert their own SQL code to run. 
This could give a user the ability to:</p>

<ul>
  <li>See information in a database they are not authorized to</li>
  <li>Add to a database they are not authorized to</li>
  <li>Delete a table in a database!</li>
</ul>

<p>Let’s see how it’s done.</p>

<h2 id="database-setup">Database Setup</h2>

<p>Let’s use the city population database similar to the one that we talked about before from <a href="http://www.sqlitetutorial.net/sqlite-import-csv/">this web tutorial</a>.</p>

<p>We are just going to use a similar schema, without loading data.</p>

<p>Using this, let’s create a table with cities and their population.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sqlite3 citydb
SQLite version 3.14.0 2016-07-26 15:17:14
Enter ".help" for usage hints.
sqlite&gt; CREATE TABLE city(
   ...&gt;   name TEXT,
   ...&gt;   population INT);
sqlite&gt;
</code></pre></div></div>

<p>Alright, schema created!</p>

<h2 id="the-code">The Code</h2>

<p>Next, let’s write a python program that connects to and uses this database.
This sill be a simple program named <code class="language-plaintext highlighter-rouge">addcity.py</code> that let’s a user input a city name and population number, and this will be inserted into the database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import sys
import sqlite3

print('Enter a city:')
city = sys.stdin.readline().strip()
print('Enter the population:')
pop = sys.stdin.readline().strip()

conn = sqlite3.connect('citydb')
query = "INSERT INTO city VALUES ('" + city + "', " + population + ")"
res = conn.execute(query)
conn.commit()
conn.close()
</code></pre></div></div>

<p>Some example runs look like:
run looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python addcity.py
Enter a city:
New York
Enter the population:
1000000
$ python addcity.py
Enter a city:
Tucson
Enter the population:
500000
$ python addcity.py
Enter a city:
San Francisco
Enter the population:
3000000
$
</code></pre></div></div>

<p>Now there are a few rows in the database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite&gt; SELECT * FROM city;
New York|1000000
Tucson|500000
San Francisco|3000000
</code></pre></div></div>

<h2 id="the-injection">The Injection</h2>

<p>The Idea with SQL injection is simple:
If a program directly uses some kind of user input in an executed SQL query, a user can type <em>whatever they want</em> as input.
If an input string can be constructed such that once all of the SQL query strings are concatenated, something unintentional happens with the DB, we have successfully “injected” our own SQL code.</p>

<p>Let’s take the example from <code class="language-plaintext highlighter-rouge">addcity.py</code>.</p>

<p>The query is constructed with this python line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>query = "INSERT INTO city VALUES ('" + city + "', " + pop + ")"
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">city</code> and <code class="language-plaintext highlighter-rouge">pop</code> are values we expect, like <code class="language-plaintext highlighter-rouge">New York</code> and <code class="language-plaintext highlighter-rouge">1000000</code>, <code class="language-plaintext highlighter-rouge">query</code> will end up being:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT INTO city VALUES ('New York', 1000000)
</code></pre></div></div>

<p>Which is a complete SQL statement (minus the <code class="language-plaintext highlighter-rouge">;</code>).
Let’s try making <code class="language-plaintext highlighter-rouge">pop</code> something more … dangerous?
What if it was <code class="language-plaintext highlighter-rouge">100000) ; DROP TABLE city ; --</code>?
<code class="language-plaintext highlighter-rouge">query</code> would become:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT INTO city VALUES ('New York', 1000000) ; DROP TABLE city ; --)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">query</code> is now a totally valid <code class="language-plaintext highlighter-rouge">INSERT</code> statement, followed by a valid <code class="language-plaintext highlighter-rouge">DROP</code> statement, followed by a comment (<code class="language-plaintext highlighter-rouge">--</code>).
If this were executed, a new row would be inserted, but the <code class="language-plaintext highlighter-rouge">city</code> table would also be dropped!</p>

<p>Another example: what if <code class="language-plaintext highlighter-rouge">pop</code> was <code class="language-plaintext highlighter-rouge">100000) ; INSERT INTO city VALUES ('Tatooine', 500000) ; --</code>
<code class="language-plaintext highlighter-rouge">query</code> would be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT INTO city VALUES ('New York', 1000000) ; INSERT INTO city VALUES ('Tatooine', 500000) ; --)'
</code></pre></div></div>

<p>The malicious user could try to insert a fictional city into the table. 
NOT COOL (but actually, pretty cool).
Let’s try this injection out with <code class="language-plaintext highlighter-rouge">addcity.py</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 addcity.py
Enter a city:
New York
Enter the population:
100000) ; INSERT INTO city VALUES ('Tatooine', 500000) ; --
Traceback (most recent call last):
  File "addcity.py", line 11, in &lt;module&gt;
  res = conn.execute(query)
sqlite3.Warning: You can only execute one statement at a time.
</code></pre></div></div>

<p>Yikes, that didn’t work.
Python gave a warning indicating that “You can only execute one statement at a time.”
In other words, the <code class="language-plaintext highlighter-rouge">execute()</code> function can only run one SQL statement at a time.
If it sees multiple statements separated by a <code class="language-plaintext highlighter-rouge">;</code>, it won’t try to run it!
(This is partially for security, and partially for simplicity).
However, there is a function on the <code class="language-plaintext highlighter-rouge">sqlite3</code> library called <code class="language-plaintext highlighter-rouge">executescript()</code>.
This function is very similar to <code class="language-plaintext highlighter-rouge">execute()</code>, except is does allow for multiple SQL statements in one input string.
Let’s replace <code class="language-plaintext highlighter-rouge">execute</code> with <code class="language-plaintext highlighter-rouge">executescript</code> in <code class="language-plaintext highlighter-rouge">addcity.py</code> and try again.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 addcity.py
Enter a city:
New York
Enter the population:
100000) ; INSERT INTO city VALUES ('Tatooine', 500000) ; --
$
</code></pre></div></div>

<p>It works!
If you look in the database, you’ll see Tatooine.
If we try the DROP one, then the DB will be removed!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 addcity.py
Enter a city:
Seattle
Enter the population:
100000) ; DROP TABLE city ; --
$
</code></pre></div></div>

<p>Check out the database with sqlite3.
Do you still see the <code class="language-plaintext highlighter-rouge">city</code> table?</p>

<hr />

<p><img src="/assets/comics/exploits_of_a_mom.png" width="600" /></p>



<footer>
    <div>&nbsp</div>
    <div style="text-align:center;">	&copy; Benjamin Dicken 2016 - 2024 </div>
    <div>&nbsp</div>
</footer>

</body>
</html>
